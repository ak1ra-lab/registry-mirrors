services:
  redis:
    cap_drop:
      - ALL
    command:
      - --maxmemory
      - 128mb
      - --maxmemory-policy
      - allkeys-lru
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    image: cgr.dev/chainguard/redis:latest
    init: true
    pull_policy: always
    read_only: false
    restart: always
    sysctls:
      # mitigate TIME-WAIT Assassination hazards in TCP
      - net.ipv4.tcp_rfc1337=1
      # SACK is commonly exploited and rarely used
      - net.ipv4.tcp_sack=0
      - net.ipv4.tcp_dsack=0
      - net.ipv4.tcp_fack=0
      # SSR could impact TCP's performance on a fixed-speed network (e.g., wired)
      - net.ipv4.tcp_slow_start_after_idle=0
    volumes:
      - "redis_data:/bitnami/redis/data"

  gcr-registry:
    cap_drop:
      - ALL
    depends_on:
      redis:
        condition: service_started
        restart: true
    environment:
      - REGISTRY_PROXY_REMOTEURL=https://gcr.io
      - OTEL_TRACES_EXPORTER=none
    image: icecodexi/registry:latest
    init: false
    labels:
      - "com.centurylinklabs.watchtower.depends-on=mirror-redis"
    pull_policy: always
    read_only: false
    restart: always
    sysctls:
      # mitigate TIME-WAIT Assassination hazards in TCP
      - net.ipv4.tcp_rfc1337=1
      # SACK is commonly exploited and rarely used
      - net.ipv4.tcp_sack=0
      - net.ipv4.tcp_dsack=0
      - net.ipv4.tcp_fack=0
      # SSR could impact TCP's performance on a fixed-speed network (e.g., wired)
      - net.ipv4.tcp_slow_start_after_idle=0
    volumes:
      - ./registry-config.yml:/etc/distribution/config.yml:ro
      - gcr_registry_data:/var/lib/registry

  k8s-registry:
    cap_drop:
      - ALL
    depends_on:
      redis:
        condition: service_started
        restart: true
    environment:
      - REGISTRY_PROXY_REMOTEURL=https://registry.k8s.io
      - OTEL_TRACES_EXPORTER=none
    image: icecodexi/registry:latest
    init: false
    labels:
      - "com.centurylinklabs.watchtower.depends-on=mirror-redis"
    pull_policy: always
    read_only: false
    restart: always
    sysctls:
      # mitigate TIME-WAIT Assassination hazards in TCP
      - net.ipv4.tcp_rfc1337=1
      # SACK is commonly exploited and rarely used
      - net.ipv4.tcp_sack=0
      - net.ipv4.tcp_dsack=0
      - net.ipv4.tcp_fack=0
      # SSR could impact TCP's performance on a fixed-speed network (e.g., wired)
      - net.ipv4.tcp_slow_start_after_idle=0
    volumes:
      - ./registry-config.yml:/etc/distribution/config.yml:ro
      - k8s_registry_data:/var/lib/registry

  docker-registry:
    cap_drop:
      - ALL
    depends_on:
      redis:
        condition: service_started
        restart: true
    environment:
      - REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io
      - OTEL_TRACES_EXPORTER=none
    image: icecodexi/registry:latest
    init: false
    labels:
      - "com.centurylinklabs.watchtower.depends-on=mirror-redis"
    ports:
      - "127.0.0.1:5000:5000"
    pull_policy: always
    read_only: false
    restart: always
    sysctls:
      # mitigate TIME-WAIT Assassination hazards in TCP
      - net.ipv4.tcp_rfc1337=1
      # SACK is commonly exploited and rarely used
      - net.ipv4.tcp_sack=0
      - net.ipv4.tcp_dsack=0
      - net.ipv4.tcp_fack=0
      # SSR could impact TCP's performance on a fixed-speed network (e.g., wired)
      - net.ipv4.tcp_slow_start_after_idle=0
    volumes:
      - ./registry-config.yml:/etc/distribution/config.yml:ro
      - docker_registry_data:/var/lib/registry

  quay-registry:
    cap_drop:
      - ALL
    depends_on:
      redis:
        condition: service_started
        restart: true
    environment:
      - REGISTRY_PROXY_REMOTEURL=https://quay.io
      - OTEL_TRACES_EXPORTER=none
    image: icecodexi/registry:latest
    init: false
    labels:
      - "com.centurylinklabs.watchtower.depends-on=mirror-redis"
    pull_policy: always
    read_only: false
    restart: always
    sysctls:
      # mitigate TIME-WAIT Assassination hazards in TCP
      - net.ipv4.tcp_rfc1337=1
      # SACK is commonly exploited and rarely used
      - net.ipv4.tcp_sack=0
      - net.ipv4.tcp_dsack=0
      - net.ipv4.tcp_fack=0
      # SSR could impact TCP's performance on a fixed-speed network (e.g., wired)
      - net.ipv4.tcp_slow_start_after_idle=0
    volumes:
      - ./registry-config.yml:/etc/distribution/config.yml:ro
      - quay_registry_data:/var/lib/registry

volumes:
  redis_data:
    driver: local
  gcr_registry_data:
    driver: local
  k8s_registry_data:
    driver: local
  docker_registry_data:
    driver: local
  quay_registry_data:
    driver: local
